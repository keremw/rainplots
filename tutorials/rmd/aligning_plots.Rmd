---
title: "Aligning Plots with Grid Extra"
author: "Mir Henglin"
date: "7/8/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


#### Dendrogram detailed walkthrough

To better understand how this works, lets walk through it step by step. To make what is going on clearer, many layout elements will initially be left visible. We start by creating the empty plot with the same layout and scale as the heatmap.

```{r}
dendro <-
  # empty ggplot with same x and y axis
  ggplot() +
  geom_blank(aes(x = response, y = term), data = longest_x_label_data) + 
  scale_x_discrete(position = 'top') +
  # Match heatmap layoutt
  thm +
  # Remove unneeded text
  theme(axis.text.y = element_blank())

grid.arrange(dendro, es_heatmap_clo, ncol = 2, widths = c(3, 15)) 
```

Having matched the plot layout, the dendrogram will now align with the heatmap.

```{r}

max_dendro <-
  max(abs(c(dendro_dat$y, dendro_dat$yend)))

offset <- max_dendro + 1

dendro <-
  dendro + 
  geom_segment(aes(x = -y+offset, y = x, xend=-yend+offset, yend=xend),
               colour = 'black', 
               data = dendro_dat)

grid.arrange(dendro, es_heatmap_clo, ncol = 2, widths = c(3, 15)) 
```

When we add the dendrogram, we see that it is perfectly aligned to the heatmap labels. However, some of the dendrogram is outside the plotted area to the left. This issue can be rectified through the `expand` argument. The second argument to `expand` controls the space to the left of the plot, and needs to be large enough so that the whole dendrogram is visible. For dendrograms of default thickness, 0.02 is a near-perfect default. For dendrograms with thicker lines, the argument will need to be larger so that the whole dendrogram is plotted. (# Note the offset value calculated above corrects a situation where otherwise the best values to pass to `expand` require a lot of trial and error.)

```{r}

dendro <-
  dendro +
  scale_x_discrete(position = 'top', expand = c(0, 0.02, 0, 0)) 

grid.arrange(dendro, es_heatmap_clo, ncol = 2, widths = c(3, 15)) 
```

To finalize the plot, we make invisible the remaining non-essential layout elements.

```{r}
dendro <-
  dendro +
  theme(panel.grid = element_blank(),
        axis.text = element_text(color = 'white'),
        panel.border = element_rect(fill = NA, color = 'white'))

grid.arrange(dendro, es_heatmap_clo, ncol = 2, widths = c(3, 15)) 
```



We will use the `gridExtra` package to display our plots together. Though our dendrogram looks okay, there will be alignment issues when we first plot the dendrogram and rainplot side by side.

```{r, message=FALSE, warning=FALSE}
library(gridExtra)
```

```{r}
grid.arrange(dendro, rainplot, ncol = 2, widths = c(3, 15))
```

As we can see, the dendrogram is not aligned with the rainplot labels. To get around this, we will use a hack. First, we will plot a modified version of the rainplot, selecting only the column with the longest label, under the dendrogram. This will align the plot area between the dendrogram and the rainplot. Second, we will make the modified rainplot invisible, so that the dendrogram appears on its own.

```{r}

x_labels <- 
  plot_data$response %>% 
  unique()

longest_x_label <-
  x_labels[[which.max(nchar(x_labels))]]


longest_plot_data <-
  plot_data %>% 
  filter(response == longest_x_label)

dendro <-
  ggplot() +
  # One-column rainplot. White Points to be invisible.
  geom_point(aes(x = response, y = term, size = p.value),
             colour = 'white',  
             data = longest_plot_data) +
  scale_x_discrete(position = 'top', expand = c(0, 3, 0, 0.1)) + 
  thm +
  # Make rainplot invisible. Remove elements that don't affect alignemnt Make
  # invisible (match background) elemnts that do affect alignment.
  theme(legend.position = 'none',
        axis.text.y = element_blank(),
        axis.text.x = element_text(colour = 'white'),
        panel.border = element_rect(fill = NA, colour = 'white')
        
  )  + 
  # Draw dendrogram
  geom_segment(aes(x = (-y + 1), y = x, xend=(-yend + 1), yend=xend),
               colour = 'black', 
               data = dendro_dat)


grid.arrange(dendro, rainplot, ncol = 2, widths = c(3, 15)) 
```
